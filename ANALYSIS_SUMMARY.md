# Marimushka Repository Analysis Summary

**Date:** 2026-02-20  
**Version:** 0.3.2  
**Branch:** copilot/fix-template-change-marimushka

---

## Executive Summary

Marimushka is a **production-grade export tool** for marimo notebooks with excellent documentation, 100% test coverage, and strong security practices. The current investigation into issue #196 ("Template for webpage generated by marimushka has changed?") reveals **no actual template file changes** between recent commits, suggesting the issue may be related to:
- External CDN changes (Tailwind CSS)
- Marimo CLI output format changes
- User environment or caching issues

---

## 1. Template System Analysis

### Default Template (tailwind.html.j2)

**Location:** `src/marimushka/templates/tailwind.html.j2`

**Key Characteristics:**
- Uses Tailwind CSS from CDN (https://cdn.tailwindcss.com)
- Implements Subresource Integrity (SRI) with hardcoded hash
- Responsive grid layout (1/2/3 columns)
- Color-coded sections:
  - Blue: Static HTML notebooks (`notebooks`)
  - Green: Interactive notebooks (`notebooks_wasm`)
  - Amber: Apps (`apps`)
- Marimo logo from GitHub CDN

**Template Variables:**
```python
notebooks        # List[Notebook] - static HTML exports
apps             # List[Notebook] - app mode exports
notebooks_wasm   # List[Notebook] - interactive WASM exports
```

**Notebook Object Properties:**
```python
display_name     # str - filename with underscores ‚Üí spaces
html_path        # Path - relative path to exported HTML
path             # Path - original .py file path
kind             # Kind enum - NB, NB_WASM, or APP
```

### Recent Template Changes

**Git Analysis:**
```bash
# Comparison between current HEAD and previous commit
$ git diff 8e4949e..dcf7e64 -- src/marimushka/templates/
# Result: No differences found
```

**Conclusion:** Template file is **byte-identical** in recent commits.

---

## 2. Project Architecture

### Core Modules (src/marimushka/)

| Module | Lines | Purpose |
|--------|-------|---------|
| export.py | ~134 | Main public API, entry point |
| orchestrator.py | ~387 | Parallel/sequential export, template rendering |
| notebook.py | ~527 | Notebook abstraction, Kind enum, export logic |
| cli.py | N/A | Typer CLI interface |
| security.py | N/A | Path validation, permissions, sanitization |
| audit.py | N/A | Security audit logging |
| validators.py | N/A | Input validation |
| config.py | N/A | Configuration file parsing |
| exceptions.py | N/A | Custom exceptions, result types |

**Total:** ~2,853 lines of Python code (well-organized, modular)

### Export Workflow

```
main(output, template, notebooks, apps, ...)
    ‚Üì
validate_template(template_file)
    ‚Üì
folder2notebooks(folder, kind) √ó 3  # NB, APP, NB_WASM
    ‚Üì
generate_index(output, template_file, notebooks, apps, notebooks_wasm)
    ‚Üì
export_all_notebooks()  # Parallel or sequential
    ‚îú‚îÄ‚îÄ export_notebooks_parallel() [ThreadPoolExecutor]
    ‚îÇ   ‚îî‚îÄ‚îÄ export_notebook() √ó N workers
    ‚îî‚îÄ‚îÄ export_notebooks_sequential()
        ‚îî‚îÄ‚îÄ export_notebook() √ó notebooks
    ‚Üì
Notebook.export(output_dir, sandbox, bin_path, timeout)
    ‚îú‚îÄ‚îÄ _resolve_executable()  # Find uvx
    ‚îú‚îÄ‚îÄ _prepare_output_path() # Validate & create dirs
    ‚îú‚îÄ‚îÄ _build_command()       # Build marimo export cmd
    ‚îî‚îÄ‚îÄ _run_export_subprocess() # Execute via subprocess
    ‚Üì
render_template(template_file, notebooks, apps, notebooks_wasm)
    ‚îî‚îÄ‚îÄ Jinja2 SandboxedEnvironment
    ‚Üì
write_index_file(output/index.html, content)
```

### Export Modes (Kind Enum)

| Kind | Output Dir | Marimo Command | Use Case |
|------|-----------|----------------|----------|
| NB | `notebooks/` | `marimo export html --sandbox` | Static HTML, read-only |
| NB_WASM | `notebooks_wasm/` | `marimo export html-wasm --mode edit --sandbox` | Interactive, editable |
| APP | `apps/` | `marimo export html-wasm --mode run --no-show-code --sandbox` | Apps, code hidden |

---

## 3. Issue #196 Investigation

### Issue Details

- **Number:** 196
- **Title:** "Template for webpage generated by marimushka has changed?"
- **Status:** Open
- **Assignees:** tschm, Copilot
- **Created:** 2026-02-20T10:56:04Z
- **Body:** (empty)

### Related Issue

- **Number:** 192
- **Title:** "Odd display of notebooks on webpage"
- **Status:** Open
- **Created:** 2026-02-20T07:15:32Z
- **Body:** (empty)

### Investigation Findings

1. **Template File Status:**
   - `src/marimushka/templates/tailwind.html.j2` is unchanged
   - Byte-identical between commits dcf7e64 and 8e4949e
   - No template modifications in recent git history

2. **Git History:**
   - Only 2 commits visible: dcf7e64 (Initial plan), 8e4949e (grafted)
   - Grafted commit suggests repository history was rewritten
   - Full template change history not available

3. **Template Dependencies:**
   - Tailwind CSS loaded from CDN: `https://cdn.tailwindcss.com`
   - SRI hash: `sha384-3hzR1LPXnJXuQpMFqYlPR4hZjbphRCkXWPMB5vzRV7rLKqHa1vW+RNa3f4aGdvPC`
   - If CDN updates, SRI will fail (by design)

4. **Possible Root Causes:**

   a. **CDN Content Change:**
      - Tailwind CSS CDN may have updated
      - SRI hash would prevent loading if content changed
      - Would cause broken styling

   b. **Marimo CLI Change:**
      - Exported HTML structure may have changed
      - New marimo version with different output format
      - Would affect appearance without template change

   c. **User Environment:**
      - Cached old template
      - Custom template configuration
      - Different marimushka version

   d. **Display Name Logic:**
      - `display_name` property replaces `_` with spaces
      - If filenames changed, display would change
      - Located in `notebook.py:444-461`

   e. **Issue Miscommunication:**
      - Empty issue body suggests unclear reporting
      - May not be template change at all

---

## 4. Recent Changes Analysis

### Git Log (Last 20 Commits)

```
dcf7e64 Initial plan
8e4949e chore(deps): update pre-commit hook astral-sh/ruff-pre-commit to v0.15.2 (#193)
```

### Commit 8e4949e (Grafted)

**Files Added/Modified:**
- Massive commit adding Rhiza framework integration
- Added: .claude/*, .github/workflows/*, .rhiza/* directories
- Added: .marimushka.toml.example, .pre-commit-config.yaml
- Added: Comprehensive documentation structure
- Updated: Pre-commit hooks (ruff v0.15.2)

**Significance:** This appears to be a framework migration/restructuring commit, possibly explaining the grafted history.

---

## 5. Strengths

### Documentation (Exceptional)

- **README.md:** Comprehensive with CI/CD examples for 5+ platforms
- **CHANGELOG.md:** Detailed version history with migration guides
- **API.md:** Python API reference
- **SECURITY.md:** Security features and vulnerability reporting
- **Specialized Docs:**
  - TROUBLESHOOTING.md
  - RECIPES.md
  - FAQ.md
  - MIGRATION.md
  - src/marimushka/templates/README.md

### Security

- Path traversal protection (`validate_path_traversal`)
- Subresource Integrity (SRI) in templates
- Sandboxed Jinja2 rendering (`SandboxedEnvironment`)
- Audit logging system
- Error message sanitization
- Secure file permissions (0o644)
- DoS protections (timeouts, worker bounds)

### Testing

- **100% test coverage** (enforced in pyproject.toml)
- Comprehensive test suite in `tests/`
- Test resources with fixtures
- Multiple CI workflows

### Performance

- Parallel export with ThreadPoolExecutor
- 3.75x speedup for 10+ notebooks
- Configurable workers (1-16, default 4)
- Rich progress bars

---

## 6. Weaknesses & Risks

### CDN Dependency

- Hardcoded SRI hash for Tailwind CSS
- CDN updates will break template (intentional security)
- No automated SRI hash updates visible
- Manual process documented but not enforced

### Configuration Complexity

- Multiple config methods: CLI, Python API, .toml file, GitHub Action
- Precedence rules not explicitly documented
- Potential for user confusion

### Git History

- Grafted commit limits traceability
- Only 2 commits visible
- Difficult to investigate historical changes
- May hinder debugging

### Issue Communication

- Issues #196 and #192 have empty bodies
- Suggests missing issue templates
- Difficult to debug without details

### Template Versioning

- No versioning mechanism for templates
- No schema validation
- Breaking changes possible if Notebook API changes
- Test templates may diverge from production templates

---

## 7. Recommendations

### Immediate (Issue #196)

1. **Request Details:** Ask issue reporter for:
   - Specific visual changes observed
   - Before/after screenshots
   - Marimushka version used
   - Marimo version used
   - Browser and deployment platform

2. **Compare Outputs:**
   - Export same notebook with different versions
   - Check actual HTML output for differences
   - Verify Tailwind CSS loading

3. **Check Dependencies:**
   - Verify marimo CLI version
   - Check if marimo export format changed
   - Test with older marimo version

### Short-Term

4. **Issue Templates:**
   - Create GitHub issue templates
   - Bug report template with required fields
   - Environment information checklist

5. **Template Testing:**
   - Add CI check for template validity
   - Ensure test templates stay in sync
   - Document template versioning strategy

6. **Documentation:**
   - Add troubleshooting section for display issues
   - Document CDN dependency and SRI implications
   - Explain configuration precedence rules

### Long-Term

7. **Template Versioning:**
   - Implement template schema validation
   - Add template compatibility checks
   - Version templates alongside code

8. **SRI Management:**
   - Automated SRI hash updates
   - CI check for CDN availability
   - Consider local/vendored CSS option

9. **Git History:**
   - Document grafted commit rationale
   - Consider un-grafting if possible
   - Maintain full history going forward

---

## 8. Conclusion

**Overall Assessment:** 8.5/10 - Solid, production-grade codebase

Marimushka is a **well-engineered tool** with exceptional documentation, strong security practices, and comprehensive testing. The current template investigation reveals **no actual template changes** in the codebase, suggesting external factors (CDN, marimo CLI, user environment) are more likely causes.

The primary weaknesses are:
1. Empty issue reports making debugging difficult
2. CDN dependency with hardcoded SRI hash
3. Grafted git history limiting traceability

**Recommended Action:** Focus on gathering detailed information from issue reporters before making code changes, as the evidence suggests the template system is working as designed.

---

## Appendix: Key Files Reference

| File | Purpose | Critical? |
|------|---------|-----------|
| `src/marimushka/templates/tailwind.html.j2` | Default template | ‚úÖ Yes |
| `src/marimushka/export.py` | Main API entry point | ‚úÖ Yes |
| `src/marimushka/orchestrator.py` | Export orchestration | ‚úÖ Yes |
| `src/marimushka/notebook.py` | Core abstractions | ‚úÖ Yes |
| `action.yml` | GitHub Action definition | ‚ö†Ô∏è Important |
| `CHANGELOG.md` | Version history | ‚ö†Ô∏è Important |
| `.marimushka.toml.example` | Config example | üìñ Reference |
| `tests/resources/templates/` | Test templates | üß™ Testing |

---

**Analysis Date:** 2026-02-20  
**Analyst:** Repository Analyzer Agent  
**Next Review:** After issue #196 resolution
