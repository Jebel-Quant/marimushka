# GitHub Actions workflow for testing the Marimushka export action
# This workflow tests various aspects of the Marimushka export functionality:
# - Exporting only notebooks (no apps)
# - Verifying template file existence
# - Testing the CLI help command

name: "ACTION"

on:
  push:  # Trigger on push events to run tests automatically

permissions:
  contents: read  # Write access to repository contents for GitHub Pages deployment

jobs:
  # Job to test exporting only notebooks (no apps)
  test-only-notebooks:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v4

      # Step 2: Test the export action with only notebooks (no apps)
      - name: "Build the virtual environment for ${{ github.repository }}"
        uses: ./actions/export
        with:
          # Only specify the notebooks folder, leave apps empty to test that scenario
          notebooks: 'src/tests/resources/notebooks'
          apps: ''
          #template: 'src/tests/resources/templates/tailwind.html.j2'


  book:
    runs-on: ubuntu-latest
    needs: test-only-notebooks

    steps:
      # Step 1: Download the marimo artifact
      # This step downloads the artifact created by the export action
      - name: Download marimo artifact
        uses: actions/download-artifact@v4
        with:
          path: book

      # Step 2: Verify the downloaded artifact
      - name: Verify downloaded artifact
        run: |

          echo "üîç Verifying artifacts..."

          # Define the files to check
          required_files=(
            "book/marimushka/index.html"
            "book/marimushka/notebooks/fibonacci.html"
            "book/marimushka/notebooks/penguins.html"
          )

          # Check each file
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing required file: $file"
              echo "üìÇ Current directory: $(pwd)"
              echo "üìÑ Listing artifacts/marimushka:"
              ls -l book/marimushka || echo "‚ùì Directory not found"
              echo "üìÑ Listing artifacts/marimushka/notebooks:"
              ls -l book/marimushka/notebooks || echo "‚ùì Directory not found"
              exit 1
            else
              echo "‚úÖ Found: $file"
            fi
          done

          echo "üéâ All required artifacts are present."

  deploy:
    runs-on: ubuntu-latest
    needs: test-only-notebooks
    permissions:
      id-token: write
      pages: write

    steps:
      # Download all artifacts from previous jobs
      # This collects the outputs from both the jupyter and marimo jobs
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: book

      - name: Inspect artifacts folder
        shell: bash
        run: |
          tree book

        # Package all artifacts for GitHub Pages deployment
        # This prepares the combined outputs for deployment
      - name: Upload static files as artifact
        id: upload
        uses: actions/upload-pages-artifact@v3 # or specific "vX.X.X" version tag for this action
        with:
          path: book/  # Path to the directory containing all artifacts

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Job to test the CLI help command
  help:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v4

      # Step 2: Set up a Python environment using uv
      - uses: astral-sh/setup-uv@v6
        with:
          python-version: 3.13

      # Step 3: Display the help screen to verify CLI functionality
      - name: Display help
        run: |
          uv run marimushka --help
          uvx marimushka --help
          uvx marimushka

      - name: Display help export
        run: |
          uv run marimushka export --help
          uvx marimushka export --help

      - name: Display version
        run: |
          uv run marimushka version
          uvx marimushka version
