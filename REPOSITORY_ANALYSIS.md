# Repository Analysis Journal

This document contains ongoing technical analysis of the marimushka repository.

---

## 2026-02-20 — Initial Analysis Entry

### Summary
Marimushka is a well-architected tool for exporting [marimo](https://marimo.io) notebooks to static HTML and WebAssembly formats. The project is at version 0.3.2, has excellent documentation, 100% test coverage, and follows modern Python development practices. Currently on branch `copilot/fix-template-change-marimushka` investigating issue #196 about potential template changes, though preliminary analysis shows the template file (`tailwind.html.j2`) is identical to the previous commit.

### Architecture Overview

**Core Components:**
1. **export.py** - Main public API (`main()` function) that orchestrates the export process
2. **orchestrator.py** - Handles parallel/sequential export, template rendering, and index generation
3. **notebook.py** - Core abstraction for marimo notebooks with `Notebook` class and `Kind` enum (NB, NB_WASM, APP)
4. **cli.py** - Typer-based command-line interface
5. **security.py** - Security utilities (path validation, file permissions, error sanitization)
6. **audit.py** - Audit logging for security events
7. **validators.py** - Input validation functions
8. **config.py** - Configuration file parsing (.marimushka.toml support)
9. **exceptions.py** - Custom exception hierarchy and result types

**Export Modes (Kind Enum):**
- **NB** (notebook): Static HTML via `marimo export html --sandbox` → `notebooks/` directory
- **NB_WASM** (notebook_wasm): Interactive WASM via `marimo export html-wasm --mode edit --sandbox` → `notebooks_wasm/` directory
- **APP** (app): App mode WASM via `marimo export html-wasm --mode run --no-show-code --sandbox` → `apps/` directory

**Template System:**
- Uses Jinja2 with `SandboxedEnvironment` for security
- Default template: `src/marimushka/templates/tailwind.html.j2`
- Template receives: `notebooks`, `apps`, `notebooks_wasm` lists of `Notebook` objects
- Each Notebook has: `display_name`, `html_path`, `path`, `kind`

### Strengths

1. **Comprehensive Documentation**
   - Excellent CHANGELOG.md with detailed version history, migration guides, and feature explanations
   - README.md with extensive examples, CI/CD integration patterns (GitHub, GitLab, CircleCI, Netlify, Vercel, AWS)
   - API.md for Python API reference
   - Dedicated docs: TROUBLESHOOTING.md, RECIPES.md, FAQ.md, MIGRATION.md
   - Template documentation: src/marimushka/templates/README.md with examples

2. **Security-First Design**
   - Path traversal protection (`validate_path_traversal`)
   - Subresource Integrity (SRI) hashes in default template
   - Sandboxed Jinja2 template rendering
   - Audit logging system (audit.py)
   - Error message sanitization to prevent information leakage
   - Secure file permissions (0o644)
   - DoS protections: timeouts, worker bounds, file size limits
   - Dedicated SECURITY.md with vulnerability reporting

3. **Testing Excellence**
   - 100% test coverage (pyproject.toml: `fail_under = 100`)
   - Comprehensive test suite in `tests/` directory
   - Test resources in `tests/resources/` including template fixtures
   - CI/CD with multiple workflows (rhiza_ci.yml, rhiza_security.yml, rhiza_codeql.yml, etc.)

4. **Modern Python Practices**
   - Type hints throughout (`strict = true` in mypy config)
   - Dataclasses (`@dataclasses.dataclass` for Notebook)
   - Enums for type safety (Kind enum)
   - Pathlib for file operations
   - Loguru for logging, Rich for CLI output
   - UV/UVX for package management and execution

5. **Parallel Export Performance**
   - Unreleased feature (in CHANGELOG): parallel export with ThreadPoolExecutor
   - Configurable workers (1-16, default 4)
   - 3.75x performance improvement for 10+ notebooks
   - Optional progress callbacks for integration
   - Rich progress bars in CLI

6. **CI/CD Integration**
   - GitHub Action (action.yml) for automated exports
   - Examples for multiple platforms (GitLab, CircleCI, Netlify, Vercel, AWS)
   - Artifact generation for GitHub Pages deployment
   - Auto-generated .nojekyll file

7. **Framework Integration**
   - Rhiza framework integration (.rhiza/ directory)
   - Automated dependency updates via Renovate
   - Pre-commit hooks configured
   - Consistent project structure

### Weaknesses

1. **Template Change Investigation Gap**
   - Issue #196 "Template for webpage generated by marimushka has changed?" has no body/description
   - Issue #192 "Odd display of notebooks on webpage" also has no details
   - Current template file is identical to previous commit (8e4949e)
   - Unclear what specific template change users are experiencing
   - May indicate communication gap between users and maintainers

2. **Limited Git History Visibility**
   - Only 2 commits visible in current branch: dcf7e64 (Initial plan) and 8e4949e (grafted)
   - Grafted history suggests repository restructuring or history rewriting
   - Difficult to trace template evolution without full history
   - No visible template changes in recent commits despite issue reports

3. **Dependency on External CDN**
   - Default template loads Tailwind CSS from `https://cdn.tailwindcss.com`
   - SRI hash hardcoded in template: `sha384-3hzR1LPXnJXuQpMFqYlPR4hZjbphRCkXWPMB5vzRV7rLKqHa1vW+RNa3f4aGdvPC`
   - If Tailwind CDN updates, SRI hash will break (intentional security feature)
   - Users may need to update template if CDN version changes
   - No local/vendored CSS option in default template

4. **Configuration Complexity**
   - Multiple configuration methods: CLI args, Python API, .marimushka.toml, GitHub Action inputs
   - Potential for confusion about precedence and overrides
   - Example config (.marimushka.toml.example) exists but precedence rules not explicitly documented

5. **Subprocess Security Considerations**
   - Uses `subprocess.run()` with `shell=False` (correct approach)
   - `# nosec B603` and `# nosec B404` suppressions for Bandit
   - Commands constructed from user input (paths, template paths)
   - Validated via `validate_bin_path` and `validate_path_traversal`, but requires careful review

6. **Error Handling for Empty Issues**
   - Issues #196 and #192 have no descriptions, making debugging difficult
   - No visible template in issue tracker or PR #197 description preview
   - Suggests need for issue templates or better bug reporting guidance

### Risks / Technical Debt

1. **Template Versioning**
   - No versioning mechanism for templates
   - Users may have cached old templates or custom templates that break with new features
   - No template schema validation
   - If template variables change (e.g., adding new fields to Notebook), old templates will fail silently

2. **Marimo CLI Dependency**
   - Entire export system depends on `uvx marimo export` CLI
   - Changes to marimo CLI interface could break marimushka
   - No version pinning or compatibility checks for marimo CLI
   - Subprocess calls assume specific marimo CLI behavior

3. **Grafted Git History**
   - Grafted commit (8e4949e) suggests history was rewritten or repository was reorganized
   - May cause issues for contributors trying to understand project evolution
   - Difficult to bisect bugs if history is incomplete

4. **Unreleased Features**
   - CHANGELOG shows extensive unreleased features (parallel export, watch mode, progress bars)
   - Version 0.3.2 in pyproject.toml but unreleased features in CHANGELOG
   - Potential gap between code and releases
   - Users on older versions may encounter different behavior

5. **Template SRI Hash Management**
   - SRI hash for Tailwind CSS is hardcoded in template
   - No automated process visible for updating SRI hashes
   - If CDN content changes, template will break
   - Documentation mentions manual hash generation (`curl | openssl dgst`) but no CI check

6. **Test Resource Staleness**
   - Test resources in `tests/resources/templates/tailwind.html.j2` may diverge from `src/marimushka/templates/tailwind.html.j2`
   - No visible mechanism to ensure test templates stay in sync with production templates

7. **Issue Communication**
   - Two open issues (#196, #192) about template/display problems with no details
   - Suggests users may not understand how to report bugs effectively
   - May indicate missing issue templates or contribution guidelines for bug reports

### Current Issue Investigation (Issue #196)

**Issue:** "Template for webpage generated by marimushka has changed?"

**Findings:**
- Template file `src/marimushka/templates/tailwind.html.j2` is **byte-identical** between commits dcf7e64 and 8e4949e
- No recent commits modify the template
- No visible template changes in git history for this branch
- Issue has no body/description, making root cause unclear

**Hypotheses:**
1. **CDN change:** Tailwind CSS CDN may have updated, causing visual differences despite same template code
2. **Marimo HTML output changed:** The marimo CLI export format may have changed, affecting rendered notebooks
3. **User environment:** User may have cached old version or custom template
4. **Variable data changed:** The `Notebook` object structure or `display_name` logic may have changed
5. **Issue miscommunication:** Issue title may not accurately reflect the actual problem

**Next Steps for Investigation:**
1. Check if marimo package version changed recently
2. Compare actual rendered HTML output between versions
3. Check if Notebook class or display_name logic changed
4. Request more details from issue reporter about specific visual changes
5. Check if issue #192 is related (also about display/webpage)

### Notable Design Decisions

1. **Sandbox by Default** - Export uses `--sandbox` flag by default (breaking change in v0.2.0), requiring notebooks to declare dependencies
2. **Three-Tier Classification** - NB (static), NB_WASM (interactive), APP (hidden code) provides flexibility
3. **Parallel by Default** - New unreleased version makes parallel export the default
4. **Security-First** - Extensive security measures (SRI, audit logging, path validation) unusual for export tool
5. **Rhiza Framework** - Integration with Jebel Quant's internal framework provides structure but adds coupling
6. **No Marimo Python API** - Uses CLI subprocess calls rather than importing marimo as library (intentional isolation)
7. **Rich CLI** - Heavy use of Rich library for beautiful terminal output
8. **Frozen Dataclasses** - Notebook class is immutable (`frozen=True`)

### Score

**8.5/10** — Solid, well-maintained, production-grade codebase with minor issues

**Justification:**
- **+2.0** Exceptional documentation (comprehensive, examples, multiple guides)
- **+2.0** Security-first design (audit logging, validation, SRI, sanitization)
- **+1.5** 100% test coverage with comprehensive test suite
- **+1.5** Modern Python practices (type hints, dataclasses, pathlib)
- **+1.0** CI/CD integration and GitHub Action
- **+0.5** Performance features (parallel export)
- **-0.5** Template change investigation gap (unclear issues)
- **-0.5** Grafted git history limits traceability
- **-0.5** CDN dependency with hardcoded SRI hash (maintenance burden)
- **-0.5** Unreleased features in CHANGELOG (version confusion)

**Recommendation:** Address issue #196 by:
1. Requesting detailed reproduction steps from reporter
2. Comparing rendered output between versions
3. Checking if marimo CLI or template rendering changed
4. Adding issue templates to prevent empty bug reports
5. Consider template versioning or compatibility checks

---

